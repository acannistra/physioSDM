---
title: "Multispecies SDM with Physiology"
output:
  html_notebook: default
  html_document: default
---

```{r}
## setup
suppressPackageStartupMessages({
  library(dismo)
  library(GRaF)
  library(raster)
  library(ggplot2)
  library(ggmap)
  library(rgbif)
  library(dplyr)
  library(maps)
})
```

The purpose here is to see if we can use priors imposed on a Gaussian Process functional family to inform species distribution models *de novo*. Much of this code is copied from files that also exist in this directory. First we'll load some of the physiology data. 

### Load Physiology

```{r}
physiology = read.csv("../data/physiology/Sundayetal_thermallimits.csv")
print(nrow(physiology))
sample_n(physiology, 10)
```

We've got 300 species total with some sort of physiological information from the literature (see Sunday et al). Let's filter to just the ones that we've got both $T_{min}$ and $T_{max}$ for:

```{r}

physiology_nona = physiology[!is.na(physiology$tmax) & !is.na(physiology$tmin),]
nrow(physiology_nona)
```
Now we've got 131 species for which species' physiology isn't an issue. Let's pick a species at random and extract the GBIF data for it. 

```{r}
spec = gsub("_", " ", sample_n(physiology_nona, 1)$species)
print(spec)
occs = occ_data(scientificName = spec, limit = 10000)
```
```{r}
occs = occs$data
print(paste(spec, "occurences:", nrow(occs)))
```

### Get pseudoabsences with range buffers. 
Here's a plot of all of these occurrences:
```{r, echo=TRUE}
occs = as.data.frame(occs)
occs = occs %>% filter(!is.na(decimalLatitude) & !is.na(decimalLongitude))
world <- map_data("world")
world <- world[world$region != "Antarctica",]
gworld = ggplot() + geom_map(data=world, map=world,
                    aes(x=long, y=lat, map_id=region),
                    color="white", fill="#7f7f7f", size=0.05, alpha=1/4)
gworld + geom_point(data=occs, aes(x=decimalLongitude, y=decimalLatitude), color='darkred')
```
That's about all of them. Let's select some pseudoabsences from here: 
```{r}
circBufs = circles(cbind(occs$decimalLongitude, occs$decimalLatitude), d= 50000, lonlat=T, dissolve=F)@polygons
gmap + geom_polygon(data=fortify(circBufs), aes(x = long, y=lat, group=group), color='blue')
```
